stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  GCR_IMAGE: gcr.io/$GCP_PROJECT_ID/app-pipeline:$CI_COMMIT_SHA

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_IMAGE -f docker/Dockerfile .
    - docker tag $DOCKER_IMAGE $CI_REGISTRY_IMAGE:latest

test:
  stage: test
  image: node:18-alpine
  script:
    - cd app
    - npm install
    - npm test

push_registry:
  stage: push
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $DOCKER_IMAGE
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - docker-deploy

push_gcr:
  stage: push
  image: google/cloud-sdk:latest
  script:
    - echo $GCP_SERVICE_KEY | base64 -d > /tmp/key.json
    - gcloud auth activate-service-account --key-file=/tmp/key.json
    - gcloud auth configure-docker
    - docker build -t $GCR_IMAGE -f docker/Dockerfile .
    - docker push $GCR_IMAGE
  only:
    - kubernetes-deploy

deploy_docker:
  stage: deploy
  image: docker:latest
  script:
    - docker pull $CI_REGISTRY_IMAGE:latest
    - docker stop app-pipeline || true
    - docker rm app-pipeline || true
    - docker run -d --name app-pipeline -p 8080:8080 $CI_REGISTRY_IMAGE:latest
  only:
    - docker-deploy

deploy_kubernetes:
  stage: deploy
  image: google/cloud-sdk:latest
  script:
    - echo $GCP_SERVICE_KEY | base64 -d > /tmp/key.json
    - gcloud auth activate-service-account --key-file=/tmp/key.json
    - gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $GCP_PROJECT_ID
    - kubectl set image deployment/app-pipeline app-pipeline=$GCR_IMAGE
    - kubectl rollout status deployment/app-pipeline
  only:
    - kubernetes-deploy
